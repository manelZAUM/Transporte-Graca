<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Consulta e Dashboard - Gra√ßa/CE</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Estilos do Dashboard */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .dash-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); border-top: 4px solid var(--verde-principal); text-align: center; }
        .dash-card h3 { color: #555; font-size: 16px; margin-bottom: 10px; }
        .dash-card .numero { font-size: 32px; font-weight: bold; color: var(--verde-escuro); }
        
        .inst-list { text-align: left; font-size: 14px; margin-top: 15px; max-height: 150px; overflow-y: auto; padding-right: 5px; }
        .inst-list div { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee; }
        
        /* Cards dos √înibus Clic√°veis */
        .bus-card { text-decoration: none; color: inherit; display: block; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s; }
        .bus-card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .bus-amarelo { border-top: 5px solid #e6b800; }
        .bus-azul { border-top: 5px solid #0056b3; }
        
        /* For√ßando a cor preta em todos os cabe√ßalhos (th) para resolver a leitura */
        th, .bus-table th { color: #000 !important; font-weight: bold; }

        .bus-table { width: 100%; margin-top: 15px; border-collapse: collapse; font-size: 13px; text-align: center; }
        .bus-table th { background: #f0f0f0; padding: 5px; border: 1px solid #ddd; }
        .bus-table td { padding: 5px; border: 1px solid #ddd; }
        .bus-amarelo .bus-table th { background: #fff8cc; }
        .bus-azul .bus-table th { background: #e6f0ff; }
    </style>
</head>
<body style="background-color: var(--fundo);">
    <header><img src="Captura de tela 2026-02-23 080257.png" alt="Governo Municipal de Gra√ßa" class="logo-prefeitura"></header>

    <div class="admin-table-container" style="margin-bottom: 40px; max-width: 1100px;">
        
        <h2 style="color: var(--verde-escuro); margin-bottom: 20px; text-align: center;">üìä Painel de Log√≠stica - Transporte Universit√°rio</h2>
        
        <div class="dashboard-grid">
            <div class="dash-card">
                <h3>üë• Total de Cadastros</h3>
                <div class="numero" id="total-alunos">0</div>
                <p style="font-size: 12px; color: #888; margin-top: 5px;">Alunos registrados no sistema</p>
            </div>
            
            <div class="dash-card" style="border-top-color: #28a745;">
                <h3>üÜï Alunos Novatos</h3>
                <div class="numero" id="total-novatos" style="color: #28a745;">0</div>
                <p style="font-size: 12px; color: #888; margin-top: 5px;">Iniciando neste semestre</p>
            </div>

            <div class="dash-card" style="border-top-color: #17a2b8;">
                <h3>üè† Residentes</h3>
                <div class="numero" id="total-residentes" style="color: #17a2b8;">0</div>
                <p style="font-size: 12px; color: #888; margin-top: 5px;">Moram em Sobral</p>
            </div>

            <div class="dash-card">
                <h3>üè´ Por Institui√ß√£o (Aprovados)</h3>
                <div class="inst-list" id="lista-instituicoes">
                    </div>
            </div>
        </div>

        <h3 style="color: var(--verde-escuro); margin-top: 10px; margin-bottom: 20px;">üöç Ocupa√ß√£o por √înibus e Turno</h3>
        <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
            
            <a href="onibus-amarelo.html" class="bus-card bus-amarelo">
                <h3 style="color: #b38f00; margin: 0; font-size: 18px;">üöå √înibus Amarelo</h3>
                <p style="font-size: 12px; color: #666; margin-top: 5px;">Clique para abrir a lista completa</p>
                <table class="bus-table">
                    <thead><tr><th>Dia</th><th>Manh√£</th><th>Noite</th></tr></thead>
                    <tbody id="tb-amarelo">
                        </tbody>
                </table>
            </a>

            <a href="onibus-azul.html" class="bus-card bus-azul">
                <h3 style="color: #0056b3; margin: 0; font-size: 18px;">üöå √înibus Azul</h3>
                <p style="font-size: 12px; color: #666; margin-top: 5px;">Clique para abrir a lista completa</p>
                <table class="bus-table">
                    <thead><tr><th>Dia</th><th>Manh√£</th><th>Noite</th></tr></thead>
                    <tbody id="tb-azul">
                        </tbody>
                </table>
            </a>
            
        </div>
        <div class="card-header" style="background-color: var(--verde-escuro); margin-top: 40px; border-radius: 8px 8px 0 0;">
            <h2>üîç Consulta de Alunos Cadastrados</h2>
        </div>

        <div style="padding:20px; display:flex; gap:10px; flex-wrap: wrap; background: white;">
            <input type="text" id="busca" placeholder="Filtrar por nome ou protocolo..." onkeyup="renderizarTabela()" style="padding:10px; flex:1; min-width: 200px; border-radius:5px; border:1px solid #ccc;">
            <a href="index.html" class="btn btn-aluno" style="width:auto; padding:10px 20px; margin: 0;">‚¨Ö Voltar ao In√≠cio</a>
        </div>
        
        <div class="table-responsive">
            <table>
                <thead>
                    <tr><th>Protocolo</th><th>Nome do Aluno (A-Z)</th><th>Institui√ß√£o</th><th>Novato</th><th>Prioridade</th><th>Status</th></tr>
                </thead>
                <tbody id="lista">
                    <tr><td colspan="6" style="text-align:center; padding: 30px;">‚è≥ Buscando dados na nuvem...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // O SEU NOVO LINK AQUI
        const API_URL = "https://script.google.com/macros/s/AKfycbyQljrcnkEox6t6IKcBvYx2wSsSoLrA8NEMGvLjK4L5sVFmqo_hxP68iEiNdbUE5xg/exec"; 
        let dadosNuvem = [];

        function buscarDadosNuvem() {
            fetch(API_URL).then(res => res.json()).then(data => {
                dadosNuvem = data; 
                gerarDashboard();
                renderizarTabela();
            }).catch(err => {
                document.getElementById('lista').innerHTML = '<tr><td colspan="6" style="text-align:center; color:red;">‚ùå N√£o foi poss√≠vel carregar as informa√ß√µes.</td></tr>';
            });
        }

        function gerarDashboard() {
            // Totais B√°sicos
            document.getElementById('total-alunos').innerText = dadosNuvem.length;
            
            // Novatos
            const novatos = dadosNuvem.filter(a => a.novato === 'Sim').length;
            document.getElementById('total-novatos').innerText = novatos;

            // Residentes
            const residentes = dadosNuvem.filter(a => a.sobral === 'Sim').length;
            document.getElementById('total-residentes').innerText = residentes;

            // Filtra s√≥ os aprovados para calcular ocupa√ß√£o e institui√ß√µes
            const aprovados = dadosNuvem.filter(a => a.status === 'Aprovado');

            // --- C√ÅLCULO DE INSTITUI√á√ïES ---
            const contagemInst = {};
            aprovados.forEach(a => {
                let inst = a.instituicao.trim();
                contagemInst[inst] = (contagemInst[inst] || 0) + 1;
            });
            
            // Ordena institui√ß√µes da maior quantidade para a menor
            const instOrdenadas = Object.keys(contagemInst).sort((a, b) => contagemInst[b] - contagemInst[a]);
            let htmlInst = '';
            instOrdenadas.forEach(inst => {
                htmlInst += `<div><strong>${inst}</strong> <span>${contagemInst[inst]}</span></div>`;
            });
            document.getElementById('lista-instituicoes').innerHTML = htmlInst || '<div style="color:#888;">Nenhum aluno aprovado.</div>';

            // --- C√ÅLCULO DE √îNIBUS, DIAS E TURNOS ---
            const instituicoesAmarelo = ["UNINTA", "FLF", "FACULDADE LUCIANO FEIJ√ÉO", "LUCIANO FEIJ√ÉO", "ANHANGUERA", "GRAU T√âCNICO", "GRAU TECNICO", "UVA-CCS", "UVA CCS"];
            const diasSemana = ['SEGUNDA', 'TER√áA', 'QUARTA', 'QUINTA', 'SEXTA'];
            
            // Estrutura para guardar os n√∫meros [√înibus][Dia][Turno]
            const contagemOnibus = {
                AMARELO: { SEGUNDA: {M:0, N:0}, TER√áA: {M:0, N:0}, QUARTA: {M:0, N:0}, QUINTA: {M:0, N:0}, SEXTA: {M:0, N:0} },
                AZUL: { SEGUNDA: {M:0, N:0}, TER√áA: {M:0, N:0}, QUARTA: {M:0, N:0}, QUINTA: {M:0, N:0}, SEXTA: {M:0, N:0} }
            };

            aprovados.forEach(aluno => {
                // Descobre qual √¥nibus o aluno pega
                const instAluno = aluno.instituicao.toUpperCase().trim();
                const vaiNoAmarelo = instituicoesAmarelo.some(inst => instAluno.includes(inst));
                const onibus = vaiNoAmarelo ? 'AMARELO' : 'AZUL';

                if(aluno.dias) {
                    diasSemana.forEach(dia => {
                        // Verifica se ele viaja de Manh√£
                        if(aluno.dias.includes(`${dia}-MANH√É`) || (aluno.dias.includes(dia) && aluno.turno === 'MANH√É' && !aluno.dias.includes("-"))) {
                            contagemOnibus[onibus][dia].M++;
                        }
                        // Verifica se ele viaja a Noite
                        if(aluno.dias.includes(`${dia}-NOITE`) || (aluno.dias.includes(dia) && aluno.turno === 'NOITE' && !aluno.dias.includes("-"))) {
                            contagemOnibus[onibus][dia].N++;
                        }
                    });
                }
            });

            // --- RENDERIZA AS TABELAS DOS CARDS ---
            let htmlAmarelo = ''; let htmlAzul = '';
            diasSemana.forEach(dia => {
                let sigla = dia.substring(0, 3); // Deixa "SEG", "TER"...
                htmlAmarelo += `<tr><td><strong>${sigla}</strong></td><td>${contagemOnibus.AMARELO[dia].M}</td><td>${contagemOnibus.AMARELO[dia].N}</td></tr>`;
                htmlAzul += `<tr><td><strong>${sigla}</strong></td><td>${contagemOnibus.AZUL[dia].M}</td><td>${contagemOnibus.AZUL[dia].N}</td></tr>`;
            });
            document.getElementById('tb-amarelo').innerHTML = htmlAmarelo;
            document.getElementById('tb-azul').innerHTML = htmlAzul;
        }

        function renderizarTabela() {
            const busca = document.getElementById('busca').value.toLowerCase();
            const tbody = document.getElementById('lista');
            tbody.innerHTML = '';
            
            // Cria uma c√≥pia para n√£o bagun√ßar o dashboard e ordena A-Z
            let dadosOrdenados = [...dadosNuvem].sort((a, b) => a.nome.localeCompare(b.nome));

            dadosOrdenados.forEach((aluno) => {
                if(aluno.nome.toLowerCase().includes(busca) || aluno.proto.toLowerCase().includes(busca)) {
                    
                    let textoPrioridade = aluno.comorbidade === "Sim" ? `<span style="background:var(--amarelo); color:white; padding:4px 10px; border-radius:15px; font-size:12px; font-weight:bold;">Sim ‚ôø</span>` : "N√£o";
                    let textoNovato = aluno.novato === "Sim" ? `<span style="color:var(--verde-principal); font-weight:bold;">Sim</span>` : "N√£o";

                    tbody.innerHTML += `<tr>
                        <td><strong>${aluno.proto}</strong></td>
                        <td>${aluno.nome}</td>
                        <td>${aluno.instituicao}</td>
                        <td>${textoNovato}</td>
                        <td>${textoPrioridade}</td>
                        <td style="color:${aluno.status === 'Pendente' ? 'orange' : 'green'}">
                            <strong>${aluno.status === 'Pendente' ? 'Em An√°lise' : aluno.status}</strong>
                        </td>
                    </tr>`;
                }
            });

            if (tbody.innerHTML === '') {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 20px;">Nenhum cadastro encontrado.</td></tr>`;
            }
        }
        
        window.onload = buscarDadosNuvem;
    </script>
</body>
</html>